<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIMI Incident Report Generator - Compact Layout</title>
    <link rel="stylesheet" href="CDN report generator style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- PDF.js Library for PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        /* Compact Layout Styles */
        .compact-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
        }

        .section-header {
            background: #007cba;
            color: white;
            margin: -20px -20px 20px -20px;
            padding: 12px 20px;
            font-weight: bold;
            font-size: 16px;
            border-radius: 8px 8px 0 0;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px; /* Reduced from 15px for more compact spacing */
            align-items: flex-start; /* Align items to top */
        }

        .form-col {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .form-col.narrow {
            flex: 0 0 300px; /* Wider to accommodate longer labels on one line */
        }

        .form-col.wide {
            flex: 2;
        }

        .form-group {
            margin-bottom: 10px; /* Reduced from 15px for more compact spacing */
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            height: 20px; /* Fixed height to ensure alignment */
            line-height: 20px;
            white-space: nowrap; /* Keep labels on one line */
            overflow: visible; /* Allow text to extend beyond if needed */
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Narrow input for country codes and similar short fields */
        .form-group .narrow-input {
            width: 100px !important;
            max-width: 100px;
        }

        /* Image preview styling */
        .evidence-logo {
            max-width: 100px;
            max-height: 60px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .dynamic-field-container {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            position: relative;
        }

        .dynamic-field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .field-number {
            background: #007cba;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .remove-field-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .remove-field-btn:hover {
            background: #c82333;
        }

        .add-field-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }

        .add-field-btn:hover {
            background: #218838;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .action-buttons button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #007cba;
            color: white;
        }

        .btn-primary:hover {
            background: #005a8a;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .objectives-ttps-section {
            display: flex;
            gap: 20px;
        }

        .objectives-panel,
        .ttps-panel {
            flex: 1;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }

        .panel-header {
            background: #f8f9fa;
            margin: -15px -15px 15px -15px;
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid #dee2e6;
        }

        .selection-counter {
            float: right;
            background: #007cba;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* Modal styles for country selector */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px 20px;
            background-color: #007cba;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover,
        .modal-close:focus {
            opacity: 0.7;
        }

        .modal-body {
            flex: 1;
            overflow: auto;
        }

        .modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .selected-country-display {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .country-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .country-item-info {
            font-size: 14px;
        }

        .country-code-badge {
            font-weight: bold;
            color: #007cba;
            margin-right: 8px;
        }

        .select-countries-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .select-countries-btn:hover {
            background: #218838;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .objectives-ttps-section {
                flex-direction: column;
            }

            .compact-container {
                padding: 10px;
            }

            .modal-content {
                width: 95%;
                height: 90vh;
                margin: 5% auto;
            }
        }

        /* Hide original form fields that we'll replace with dynamic ones */
        #recommendations, 
        #sub-narratives-container,
        .sub-narrative-group:not(:first-child),
        .recommendation-group:not(:first-child) {
            display: none;
        }
    </style>
</head>
<body>
    <div class="compact-container">
        <header style="text-align: center; margin-bottom: 30px;">
            <h1>FIMI Incident Report Generator</h1>
        </header>

        <form id="incidentForm">
            <!-- Basic Information Section -->
            <div class="form-section">
                <div class="section-header">üìã Basic Information</div>
                
                <div class="form-row">
                    <div class="form-col narrow">
                        <div class="form-group">
                            <label for="incidentNumber" title="Incident Number">Incident Number:</label>
                            <input type="text" id="incidentNumber" placeholder="e.g., 2024-001">
                        </div>
                    </div>
                    <div class="form-col narrow">
                        <div class="form-group">
                            <label for="tlpLevel" title="TLP Level">TLP Level:</label>
                            <select id="tlpLevel">
                                <option value="TLP:CLEAR">TLP:CLEAR</option>
                                <option value="TLP:GREEN">TLP:GREEN</option>
                                <option value="TLP:AMBER">TLP:AMBER</option>
                                <option value="TLP:RED">TLP:RED</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="date" title="Date">Date:</label>
                            <input type="date" id="date">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="title" title="Incident Title">Incident Title:</label>
                            <input type="text" id="title" placeholder="Brief descriptive title">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="reporturlInput">Report URL:</label>
                            <input type="url" id="reporturlInput" placeholder="https://example.com/report">
                            <div id="reporturlError" style="color: red; font-size: 12px; display: none;"></div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="incidentDescription">Incident Description:</label>
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <textarea id="incidentDescription" rows="4" placeholder="Enter or generate a description of the incident..." style="flex: 1;"></textarea>
                                <button type="button" class="add-field-btn" onclick="generateAIIncidentDescription()" style="width: 150px; margin-top: 0;">Generate</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="authorName1" title="Author Name">Author's Name:</label>
                            <input type="text" id="authorName1" class="author-name-input" placeholder="Name">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="authorOrg1" title="Author Organization">Author's Organization:</label>
                            <input type="text" id="authorOrg1" class="author-org-input" placeholder="Organization">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label style="visibility: hidden;">Placeholder</label> <!-- Hidden label to maintain spacing -->
                            <button type="button" class="add-field-btn" onclick="addInlineAuthor()" style="width: 150px; margin-top: 0;">+ Add Author</button>
                        </div>
                    </div>
                </div>

                <div id="additional-authors"></div>
            </div>

            <!-- Assessment Section -->
            <div class="form-section">
                <div class="section-header">üîç Assessment</div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="threatActor" title="Threat Actor(s)">Threat Actor(s):</label>
                            <input type="text" id="threatActor" placeholder="e.g., Russia, China etc.">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="platforms" title="Platforms">Platforms:</label>
                            <select id="platforms" multiple>
                                <option value="9Gag">9Gag</option>
                                <option value="Badoo">Badoo</option>
                                <option value="Baidu Tieba">Baidu Tieba</option>
                                <option value="Behance">Behance</option>
                                <option value="BeReal">BeReal</option>
                                <option value="Bilibili">Bilibili</option>
                                <option value="Bluesky">Bluesky</option>
                                <option value="Bumble Bizz">Bumble Bizz</option>
                                <option value="Clubhouse">Clubhouse</option>
                                <option value="Discord">Discord</option>
                                <option value="Douban">Douban</option>
                                <option value="Douyin">Douyin</option>
                                <option value="Dribbble">Dribbble</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Fanbase">Fanbase</option>
                                <option value="Flickr">Flickr</option>
                                <option value="Hi5">Hi5</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Kiwibox">Kiwibox</option>
                                <option value="Kuaishou">Kuaishou</option>
                                <option value="Lemon8">Lemon8</option>
                                <option value="Likee">Likee</option>
                                <option value="Line">Line</option>
                                <option value="LinkedIn">LinkedIn</option>
                                <option value="Little Red Book / Xiaohongshu (RedNote)">Little Red Book / Xiaohongshu (RedNote)</option>
                                <option value="Mastodon">Mastodon</option>
                                <option value="Meetup">Meetup</option>
                                <option value="Nextdoor">Nextdoor</option>
                                <option value="Ning">Ning</option>
                                <option value="Noplace">Noplace</option>
                                <option value="Odnoklassniki">Odnoklassniki</option>
                                <option value="Phoenix">Phoenix</option>
                                <option value="PI.FYI">PI.FYI</option>
                                <option value="Picsart">Picsart</option>
                                <option value="Pinterest">Pinterest</option>
                                <option value="QQ">QQ</option>
                                <option value="Qzone">Qzone</option>
                                <option value="Quora">Quora</option>
                                <option value="Reddit">Reddit</option>
                                <option value="RedNote (Xiaohongshu)">RedNote (Xiaohongshu)</option>
                                <option value="Ren">Ren</option>
                                <option value="Renren">Renren</option>
                                <option value="Roblox">Roblox</option>
                                <option value="Roposo">Roposo</option>
                                <option value="Snapchat">Snapchat</option>
                                <option value="Substack">Substack</option>
                                <option value="Tagged">Tagged</option>
                                <option value="Telegram">Telegram</option>
                                <option value="Threads">Threads</option>
                                <option value="TikTok">TikTok</option>
                                <option value="Tumblr">Tumblr</option>
                                <option value="Twitch">Twitch</option>
                                <option value="Vibe">Vibe</option>
                                <option value="VKontakte (VK)">VKontakte (VK)</option>
                                <option value="WeChat">WeChat</option>
                                <option value="Weibo">Weibo</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="X (Twitter)">X (Twitter)</option>
                                <option value="Xing">Xing</option>
                                <option value="Yizhibo">Yizhibo</option>
                                <option value="Youku Tudou">Youku Tudou</option>
                                <option value="YouTube">YouTube</option>
                                <option value="Zhihu">Zhihu</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Targeted Countries:</label>
                            <button type="button" class="select-countries-btn" onclick="openCountrySelector()">Select Countries</button>
                            <div id="selected-countries-display" class="selected-country-display" style="display: none;">
                                <!-- Selected countries will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="reach">Reach & Scale:</label>
                            <textarea id="reach" placeholder="Audience reach and scale metrics"></textarea>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="outcome">Outcome Assessment:</label>
                            <textarea id="outcome" placeholder="Observed outcomes and effects"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Narratives Section -->
            <div class="form-section">
                <div class="section-header">üìñ Narratives</div>
                
                <div id="meta-narratives-container">
                    <!-- First meta-narrative (cannot be removed) -->
                    <div class="meta-narrative-group" data-meta-index="1">
                        <div class="dynamic-field-container" style="background: #f0f8ff; border: 2px solid #007cba;">
                            <div class="dynamic-field-header">
                                <span class="field-number" style="background: #007cba;">Meta-Narrative 1</span>
                            </div>
                            <textarea class="meta-narrative-text" placeholder="Overarching narrative theme..." rows="4"></textarea>
                            
                            <div class="sub-narratives-container" data-meta-index="1" style="margin-top: 15px; padding-left: 20px; border-left: 3px solid #007cba;">
                                <div class="dynamic-field-container" style="background: white; position: relative;">
                                    <div class="dynamic-field-header">
                                        <span class="field-number" style="background: #6c757d;">Sub-Narrative 1.1</span>
                                    </div>
                                    <textarea class="sub-narrative-text" placeholder="Describe the first sub-narrative..." rows="3"></textarea>
                                </div>
                            </div>
                            <button type="button" class="add-field-btn" data-meta-index="1" style="margin-top: 10px; font-size: 13px; padding: 6px 12px;">+ Add Sub-Narrative</button>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="add-field-btn" onclick="addMetaNarrative()" style="margin-top: 15px;">+ Add Another Meta-Narrative</button>
            </div>

            <!-- DISARM Framework Section -->
            <div class="form-section">
                <div class="section-header">üõ°Ô∏è DISARM Framework Analysis</div>
                
                <div class="action-buttons">
                    <button type="button" class="btn-secondary" onclick="uploadNavigatorFile()">üìÅ Upload Navigator File</button>
                    <button type="button" class="btn-primary" onclick="openDISARMFramework()">üéØ Interactive DISARM Framework</button>
                    <button type="button" class="btn-success" onclick="openTechniqueSelector()">üîç Add Individual Technique</button>
                </div>

                <div class="objectives-ttps-section">
                    <div class="objectives-panel">
                        <div class="panel-header">
                            Objectives 
                            <span class="selection-counter" id="objectives-counter">0/2</span>
                        </div>
                        <div id="objectives-container">
                            <p style="color: #666; font-style: italic;">Select objectives using the tools above...</p>
                        </div>
                    </div>

                    <div class="ttps-panel">
                        <div class="panel-header">
                            TTPs (Techniques, Tactics, Procedures)
                            <span class="selection-counter" id="ttps-counter">0/4</span>
                        </div>
                        <div id="ttps-container">
                            <p style="color: #666; font-style: italic;">Select TTPs using the tools above...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Incident Response Section -->
            <div class="form-section">
                <div class="section-header">üí° Incident Response</div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="actionsTaken">Actions Taken:</label>
                            <textarea id="actionsTaken" placeholder="Response actions and mitigation measures"></textarea>
                        </div>
                    </div>
                </div>
                
                <div id="dynamic-recommendations">
                    <div class="dynamic-field-container">
                        <div class="dynamic-field-header">
                            <span class="field-number">Recommendation 1</span>
                        </div>
                        <textarea class="recommendation-text" placeholder="Describe the first recommendation..." rows="3"></textarea>
                    </div>
                </div>
                <button type="button" class="add-field-btn" onclick="addRecommendation()">+ Add Another Recommendation</button>
            </div>

            <!-- URLs Section -->
            <div class="form-section">
                <div class="section-header">üîó Trusted URLs</div>
                
                <!-- Message container for status updates -->
                <div id="urls-message" style="display: none; padding: 10px; margin-bottom: 15px; border-radius: 4px; background: #f8f9fa;"></div>
                
                <!-- Action Buttons -->
                <div class="form-row">
                    <div class="form-col">
                        <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <label for="googleSheetsUrl" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">Google Sheet:</label>
                                <input type="url" id="googleSheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/..." 
                                       style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                <div id="googleSheetsUrlError" style="color: red; font-size: 12px; margin-top: 2px; display: none;"></div>
                            </div>
                            <button type="button" onclick="loadUrlsFromGoogleSheets()" 
                                    style="background: #007cba; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; white-space: nowrap;"
                                    onmouseover="this.style.background='#005a8a'" 
                                    onmouseout="this.style.background='#007cba'">
                                üìä Load URLs from Google Sheet
                            </button>
                            <button type="button" onclick="addUrl()" 
                                    style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; white-space: nowrap;"
                                    onmouseover="this.style.background='#218838'" 
                                    onmouseout="this.style.background='#28a745'">
                                + Add URL
                            </button>
                        </div>
                    </div>
                </div>

                <!-- URLs Container -->
                <div id="urls-container">
                    <!-- URLs will be dynamically added here -->
                </div>
            </div>

            <!-- Malicious URLs Section -->
            <div class="form-section">
                <div class="section-header">üö® Malicious URLs</div>
                
                <!-- Message container for status updates -->
                <div id="malicious-urls-message" style="display: none; padding: 10px; margin-bottom: 15px; border-radius: 4px; background: #f8f9fa;"></div>
                
                <!-- Action Buttons -->
                <div class="form-row">
                    <div class="form-col">
                        <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <label for="maliciousGoogleSheetsUrl" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">Google Sheet:</label>
                                <input type="url" id="maliciousGoogleSheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/..." 
                                       style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                <div id="maliciousGoogleSheetsUrlError" style="color: red; font-size: 12px; margin-top: 2px; display: none;"></div>
                            </div>
                            <button type="button" onclick="loadMaliciousUrlsFromGoogleSheets()" 
                                    style="background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; white-space: nowrap;"
                                    onmouseover="this.style.background='#c82333'" 
                                    onmouseout="this.style.background='#dc3545'">
                                üìä Load URLs from Google Sheet
                            </button>
                            <button type="button" onclick="addMaliciousUrl()" 
                                    style="background: #ffc107; color: #212529; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; white-space: nowrap;"
                                    onmouseover="this.style.background='#e0a800'" 
                                    onmouseout="this.style.background='#ffc107'">
                                + Add URL
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Malicious URLs Container -->
                <div id="malicious-urls-container">
                    <!-- URLs will be dynamically added here -->
                </div>
            </div>

            <!-- Executive Summary Section -->
            <div class="form-section">
                <div class="section-header">üìù Executive Summary</div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="executive-summary">Executive Summary:</label>
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <textarea id="executive-summary" rows="6" placeholder="Enter or generate an executive summary..." style="flex: 1;"></textarea>
                                <button type="button" class="add-field-btn" onclick="generateExecutiveSummary()" style="width: 150px; margin-top: 0;">Generate</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="form-section">
                <div class="section-header">üöÄ Generate Report</div>
                
                <div class="action-buttons">
                    <button type="button" class="btn-success" onclick="downloadAsDocx()">üìÑ Download as Word Document</button>
                    <!-- <button type="button" class="btn-primary" onclick="downloadAsPDF()">üìë Download as PDF</button> -->
                    <button type="button" class="btn-secondary" onclick="resetForm()">üîÑ Reset Form</button>
                </div>
            </div>
        </form>
        
        <!-- Footer -->
        <footer style="text-align: center; margin-top: 30px; padding: 20px 0; color: #999; font-size: 12px;">
            Thank you to Debunk.org, Alliance4Europe, and the DISARM Foundation for their contributions to the template.
        </footer>
    </div>

    <!-- Hidden original form elements for compatibility -->
    <div style="display: none;">
        <div id="sub-narratives-container"></div>
        <div id="recommendations"></div>
        <input type="file" id="imageInput" accept="image/*">
    </div>

    <!-- Module Scripts - Load in dependency order -->
    <script src="config.js" defer></script>
    <script src="pdf-ai-summarizer.js" defer></script>
    <script src="form-data-processing.js" defer></script>
    <script src="disarm-framework-integration.js" defer></script>
    <script src="objectives-ttps-management.js" defer></script>
    <script src="urls-management.js" defer></script>
    <script src="url-validation.js" defer></script>
    <script src="ui-interactions.js" defer></script>
    <script src="docx-header-tables.js" defer></script>
    <script src="docx-summary-table.js" defer></script>
    <script src="docx-content-tables.js" defer></script>
    <script src="docx-footer-tables.js" defer></script>
    <script src="docx-generator.js" defer></script>
    <script src="image-handling.js" defer></script>
    <script src="main.js" defer></script>

    <script>
        // Dynamic field management functions
        // Note: subNarrativeCount, recommendationCount, and authorCount are declared in config.js

        function addInlineAuthor() {
            authorCount++;
            const container = document.getElementById('additional-authors');
            const newAuthorRow = document.createElement('div');
            newAuthorRow.className = 'form-row';
            newAuthorRow.innerHTML = `
                <div class="form-col">
                    <div class="form-group">
                        <input type="text" id="authorName${authorCount}" class="author-name-input" placeholder="Name">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <input type="text" id="authorOrg${authorCount}" class="author-org-input" placeholder="Organization">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <button type="button" class="remove-field-btn" onclick="removeInlineAuthor(this)">Remove</button>
                    </div>
                </div>
            `;
            container.appendChild(newAuthorRow);
        }

        function removeInlineAuthor(button) {
            button.closest('.form-row').remove();
        }

        // Function to collect all authors for form submission
        function collectAuthors() {
            const authors = [];
            const nameInputs = document.querySelectorAll('.author-name-input');
            const orgInputs = document.querySelectorAll('.author-org-input');
            
            for (let i = 0; i < nameInputs.length; i++) {
                const name = nameInputs[i].value.trim();
                const org = orgInputs[i].value.trim();
                if (name && org) {
                    authors.push(`${name}, ${org}`);
                }
            }
            return authors.join('; ');
        }

        // Override the functions from ui-interactions.js after DOM loads
        window.addEventListener('DOMContentLoaded', function() {
            // Override addRecommendation for compact form
            window.addRecommendation = function() {
                recommendationCount++;
                const container = document.getElementById('dynamic-recommendations');
                const newField = document.createElement('div');
                newField.className = 'dynamic-field-container';
                newField.innerHTML = `
                    <div class="dynamic-field-header">
                        <span class="field-number">Recommendation ${recommendationCount}</span>
                        <button type="button" class="remove-field-btn" onclick="removeRecommendation(this)">Remove</button>
                    </div>
                    <textarea class="recommendation-text" placeholder="Describe this recommendation..." rows="3"></textarea>
                `;
                container.appendChild(newField);
            };
        });

        // Track meta-narrative count
        let metaNarrativeCount = 1;

        function addMetaNarrative() {
            metaNarrativeCount++;
            const container = document.getElementById('meta-narratives-container');
            const newMetaGroup = document.createElement('div');
            newMetaGroup.className = 'meta-narrative-group';
            newMetaGroup.setAttribute('data-meta-index', metaNarrativeCount);
            newMetaGroup.innerHTML = `
                <div class="dynamic-field-container" style="background: #f0f8ff; border: 2px solid #007cba; margin-top: 20px;">
                    <div class="dynamic-field-header">
                        <span class="field-number" style="background: #007cba;">Meta-Narrative ${metaNarrativeCount}</span>
                        <button type="button" class="remove-field-btn" onclick="removeMetaNarrative(this)">Remove</button>
                    </div>
                    <textarea class="meta-narrative-text" placeholder="Overarching narrative theme..." rows="4"></textarea>
                    
                    <div class="sub-narratives-container" data-meta-index="${metaNarrativeCount}" style="margin-top: 15px; padding-left: 20px; border-left: 3px solid #007cba;">
                        <div class="dynamic-field-container" style="background: white; position: relative;">
                            <div class="dynamic-field-header">
                                <span class="field-number" style="background: #6c757d;">Sub-Narrative ${metaNarrativeCount}.1</span>
                            </div>
                            <textarea class="sub-narrative-text" placeholder="Describe the first sub-narrative..." rows="3"></textarea>
                        </div>
                    </div>
                    <button type="button" class="add-field-btn" data-meta-index="${metaNarrativeCount}" style="margin-top: 10px; font-size: 13px; padding: 6px 12px;">+ Add Sub-Narrative</button>
                </div>
            `;
            container.appendChild(newMetaGroup);
        }

        function removeMetaNarrative(button) {
            button.closest('.meta-narrative-group').remove();
            // Renumber remaining meta-narratives
            renumberMetaNarratives();
        }

        function addSubNarrativeCompact(metaIndex) {
            console.log('addSubNarrativeCompact called with metaIndex:', metaIndex);
            const metaGroup = document.querySelector(`.meta-narrative-group[data-meta-index="${metaIndex}"]`);
            console.log('Found metaGroup:', metaGroup);
            if (!metaGroup) {
                console.error('Meta group not found for index:', metaIndex);
                return;
            }
            
            const subContainer = metaGroup.querySelector('.sub-narratives-container');
            console.log('Found subContainer:', subContainer);
            const currentSubCount = subContainer.querySelectorAll('.dynamic-field-container').length;
            const newSubIndex = currentSubCount + 1;
            console.log('Creating sub-narrative:', metaIndex + '.' + newSubIndex);
            
            const newField = document.createElement('div');
            newField.className = 'dynamic-field-container';
            newField.style.background = 'white';
            newField.style.position = 'relative';
            newField.innerHTML = `
                <div class="dynamic-field-header">
                    <span class="field-number" style="background: #6c757d;">Sub-Narrative ${metaIndex}.${newSubIndex}</span>
                    <button type="button" class="remove-field-btn" onclick="removeSubNarrativeCompact(this)">Remove</button>
                </div>
                <textarea class="sub-narrative-text" placeholder="Describe this sub-narrative..." rows="3"></textarea>
            `;
            subContainer.appendChild(newField);
            console.log('Sub-narrative added successfully');
        }

        function removeSubNarrativeCompact(button) {
            const metaGroup = button.closest('.meta-narrative-group');
            const metaIndex = metaGroup.getAttribute('data-meta-index');
            button.closest('.dynamic-field-container').remove();
            
            // Renumber remaining sub-narratives in this meta-narrative
            const subContainers = metaGroup.querySelectorAll('.sub-narratives-container .dynamic-field-container');
            subContainers.forEach((container, index) => {
                container.querySelector('.field-number').textContent = `Sub-Narrative ${metaIndex}.${index + 1}`;
            });
        }

        function renumberMetaNarratives() {
            const metaGroups = document.querySelectorAll('.meta-narrative-group');
            metaGroups.forEach((group, index) => {
                const newMetaIndex = index + 1;
                group.setAttribute('data-meta-index', newMetaIndex);
                
                // Update meta-narrative number
                const metaFieldNumber = group.querySelector('.dynamic-field-header > .field-number');
                metaFieldNumber.textContent = `Meta-Narrative ${newMetaIndex}`;
                
                // Update sub-narratives container data attribute
                const subNarrativesContainer = group.querySelector('.sub-narratives-container');
                if (subNarrativesContainer) {
                    subNarrativesContainer.setAttribute('data-meta-index', newMetaIndex);
                }
                
                // Update sub-narrative numbers
                const subContainers = group.querySelectorAll('.sub-narratives-container .dynamic-field-container');
                subContainers.forEach((subContainer, subIndex) => {
                    subContainer.querySelector('.field-number').textContent = `Sub-Narrative ${newMetaIndex}.${subIndex + 1}`;
                });
                
                // Update the add button data-meta-index attribute
                const addButton = group.querySelector('.add-field-btn[data-meta-index]');
                if (addButton) {
                    addButton.setAttribute('data-meta-index', newMetaIndex);
                }
            });
            metaNarrativeCount = metaGroups.length;
        }

        function addRecommendation() {
            recommendationCount++;
            const container = document.getElementById('dynamic-recommendations');
            const newField = document.createElement('div');
            newField.className = 'dynamic-field-container';
            newField.innerHTML = `
                <div class="dynamic-field-header">
                    <span class="field-number">Recommendation ${recommendationCount}</span>
                    <button type="button" class="remove-field-btn" onclick="removeRecommendation(this)">Remove</button>
                </div>
                <textarea class="recommendation-text" placeholder="Describe this recommendation..." rows="3"></textarea>
            `;
            container.appendChild(newField);
        }

        function removeRecommendation(button) {
            button.closest('.dynamic-field-container').remove();
            // Renumber remaining fields
            const containers = document.querySelectorAll('#dynamic-recommendations .dynamic-field-container');
            containers.forEach((container, index) => {
                container.querySelector('.field-number').textContent = `Recommendation ${index + 1}`;
            });
            recommendationCount = containers.length;
        }

        // Update counters when objectives/TTPs change
        function updateCounters() {
            // Check if the global variables are available
            if (typeof objectivesList === 'undefined' || typeof ttpsList === 'undefined') {
                return;
            }
            
            const objectivesCounter = document.getElementById('objectives-counter');
            const ttpsCounter = document.getElementById('ttps-counter');
            
            if (objectivesCounter) {
                const objCount = objectivesList.length;
                objectivesCounter.textContent = `${objCount} (rec: 2)`;
                
                // Update color based on count
                if (objCount > 2) {
                    objectivesCounter.style.backgroundColor = '#dc3545'; // Red for exceeding
                    objectivesCounter.style.color = 'white';
                } else if (objCount === 2) {
                    objectivesCounter.style.backgroundColor = '#28a745'; // Green for at limit
                    objectivesCounter.style.color = 'white';
                } else {
                    objectivesCounter.style.backgroundColor = '#007cba'; // Default blue
                    objectivesCounter.style.color = 'white';
                }
            }
            if (ttpsCounter) {
                const ttpCount = ttpsList.length;
                ttpsCounter.textContent = `${ttpCount} (rec: 4)`;
                
                // Update color based on count
                if (ttpCount > 4) {
                    ttpsCounter.style.backgroundColor = '#dc3545'; // Red for exceeding
                    ttpsCounter.style.color = 'white';
                } else if (ttpCount === 4) {
                    ttpsCounter.style.backgroundColor = '#28a745'; // Green for at limit
                    ttpsCounter.style.color = 'white';
                } else {
                    ttpsCounter.style.backgroundColor = '#007cba'; // Default blue
                    ttpsCounter.style.color = 'white';
                }
            }
        }

        // Override the original updateSelectionInfo function to also update our counters
        const originalUpdateSelectionInfo = window.updateSelectionInfo;
        window.updateSelectionInfo = function() {
            if (originalUpdateSelectionInfo) {
                originalUpdateSelectionInfo();
            }
            updateCounters();
        };

        // Initialize counters on page load (with retry for external scripts)
        document.addEventListener('DOMContentLoaded', function() {
            function tryUpdateCounters() {
                if (typeof objectivesList !== 'undefined' && typeof ttpsList !== 'undefined') {
                    updateCounters();
                } else {
                    setTimeout(tryUpdateCounters, 100);
                }
            }
            tryUpdateCounters();
            
            // Add event delegation for add sub-narrative buttons
            const metaNarrativesContainer = document.getElementById('meta-narratives-container');
            if (metaNarrativesContainer) {
                metaNarrativesContainer.addEventListener('click', function(e) {
                    // Check if clicked element or its parent is the add sub-narrative button
                    let target = e.target;
                    if (!target.classList.contains('add-field-btn')) {
                        target = target.closest('.add-field-btn');
                    }
                    
                    if (target && target.hasAttribute('data-meta-index') && target.classList.contains('add-field-btn')) {
                        e.preventDefault();
                        e.stopPropagation();
                        const metaIndex = parseInt(target.getAttribute('data-meta-index'));
                        console.log('Button clicked, calling addSubNarrativeCompact with index:', metaIndex);
                        addSubNarrativeCompact(metaIndex);
                    }
                });
            }
        });

        function resetForm() {
            if (confirm('Are you sure you want to reset the entire form? This will clear all entered data.')) {
                document.getElementById('incidentForm').reset();
                
                // Reset meta-narratives to just one with one sub-narrative
                document.getElementById('meta-narratives-container').innerHTML = `
                    <div class="meta-narrative-group" data-meta-index="1">
                        <div class="dynamic-field-container" style="background: #f0f8ff; border: 2px solid #007cba;">
                            <div class="dynamic-field-header">
                                <span class="field-number" style="background: #007cba;">Meta-Narrative 1</span>
                            </div>
                            <textarea class="meta-narrative-text" placeholder="Overarching narrative theme..." rows="4"></textarea>
                            
                            <div class="sub-narratives-container" data-meta-index="1" style="margin-top: 15px; padding-left: 20px; border-left: 3px solid #007cba;">
                                <div class="dynamic-field-container" style="background: white; position: relative;">
                                    <div class="dynamic-field-header">
                                        <span class="field-number" style="background: #6c757d;">Sub-Narrative 1.1</span>
                                    </div>
                                    <textarea class="sub-narrative-text" placeholder="Describe the first sub-narrative..." rows="3"></textarea>
                                </div>
                            </div>
                            <button type="button" class="add-field-btn" data-meta-index="1" style="margin-top: 10px; font-size: 13px; padding: 6px 12px;">+ Add Sub-Narrative</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('dynamic-recommendations').innerHTML = `
                    <div class="dynamic-field-container">
                        <div class="dynamic-field-header">
                            <span class="field-number">Recommendation 1</span>
                        </div>
                        <textarea class="recommendation-text" placeholder="Describe the first recommendation..." rows="3"></textarea>
                    </div>
                `;
                
                // Reset additional authors
                document.getElementById('additional-authors').innerHTML = '';
                
                metaNarrativeCount = 1;
                recommendationCount = 1;
                authorCount = 1;
                
                // Clear objectives and TTPs
                objectivesList = [];
                ttpsList = [];
                
                // Reset containers
                document.getElementById('objectives-container').innerHTML = '<p style="color: #666; font-style: italic;">Select objectives using the tools above...</p>';
                document.getElementById('ttps-container').innerHTML = '<p style="color: #666; font-style: italic;">Select TTPs using the tools above...</p>';
                
                // Clear selected countries
                selectedTargetedCountries = [];
                updateSelectedCountriesDisplay();
                
                updateCounters();
            }
        }

        // AI Incident Description Generation
        async function generateAIIncidentDescription() {
            const reportUrlField = document.getElementById('reporturlInput');
            const incidentDescField = document.getElementById('incidentDescription');
            const button = event.target;
            
            if (!reportUrlField.value.trim()) {
                alert('Please enter a Report URL first');
                reportUrlField.focus();
                return;
            }
            
            if (!reportUrlField.value.toLowerCase().includes('.pdf')) {
                if (!confirm('The URL doesn\'t appear to be a PDF. Continue anyway?')) {
                    return;
                }
            }
            
            // Check if the PDF AI summarizer function is available
            if (typeof generateIncidentDescription === 'undefined') {
                alert('AI summarization feature is not available. Please ensure the PDF AI summarizer module is loaded.');
                return;
            }
            
            try {
                button.disabled = true;
                button.textContent = 'Processing...';
                
                // Call the PDF AI summarizer function
                await generateIncidentDescription(reportUrlField.value);
                
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Generate';
            }
        }

        // Executive Summary Generation
        async function generateExecutiveSummary() {
            const button = event.target;
            
            try {
                button.disabled = true;
                button.textContent = 'Processing...';
                
                // Show progress indicator
                showProgressIndicator('Generating executive summary...');
                
                // Collect data from form fields
                const incidentDescription = document.getElementById('incidentDescription')?.value || '';
                
                // Impact Assessment: concatenation of reach and outcome
                const reach = document.getElementById('reach')?.value || '';
                const outcome = document.getElementById('outcome')?.value || '';
                const impactAssessment = [reach, outcome].filter(text => text.trim()).join(' ');
                
                // Narrative Summary: metaNarrative + all sub-narratives
                const metaNarrative = document.getElementById('metaNarrative')?.value || '';
                const subNarratives = Array.from(document.querySelectorAll('.sub-narrative-text'))
                    .map(textarea => textarea.value)
                    .filter(text => text.trim());
                const narrativeSummary = [metaNarrative, ...subNarratives].filter(text => text.trim()).join(' ');
                
                // TTPs Summary: objectives + TTPs from containers
                const objectivesContainer = document.getElementById('objectives-container');
                const ttpsContainer = document.getElementById('ttps-container');
                
                let objectives = '';
                let ttps = '';
                
                if (objectivesContainer) {
                    const objectiveElements = objectivesContainer.querySelectorAll('div, p, span');
                    objectives = Array.from(objectiveElements)
                        .map(el => el.textContent)
                        .filter(text => text.trim() && !text.includes('Select objectives'))
                        .join(' ');
                }
                
                if (ttpsContainer) {
                    const ttpElements = ttpsContainer.querySelectorAll('div, p, span');
                    ttps = Array.from(ttpElements)
                        .map(el => el.textContent)
                        .filter(text => text.trim() && !text.includes('Select TTPs'))
                        .join(' ');
                }
                
                const ttpsSummary = [objectives, ttps].filter(text => text.trim()).join(' ');
                
                // Recommendations: actionsTaken + all recommendations
                const actionsTaken = document.getElementById('actionsTaken')?.value || '';
                const recommendations = Array.from(document.querySelectorAll('.recommendation-text'))
                    .map(textarea => textarea.value)
                    .filter(text => text.trim());
                const recommendationsSummary = [actionsTaken, ...recommendations].filter(text => text.trim()).join(' ');
                
                // Create prompt for executive summary
                const sections = [
                    { name: 'Incident Summary', content: incidentDescription },
                    { name: 'Impact Assessment', content: impactAssessment },
                    { name: 'Narrative Summary', content: narrativeSummary },
                    { name: 'TTPs Summary', content: ttpsSummary },
                    { name: 'Recommendations', content: recommendationsSummary }
                ].filter(section => section.content.trim());
                
                if (sections.length === 0) {
                    throw new Error('No content found in form fields to summarize. Please fill in some form data first.');
                }
                
/*                 const prompt = `Please create a concise five line executive summary based on the following FIMI incident information:

${sections.map(section => `${section.name}: ${section.content}`).join('\n\n')}

Provide one line for each section as follows:

1. Incident Summary: [one line summary]
2. Narrative Summary: [one line summary]
3. Impact Assessment: [one line summary]
4. TTPs Summary: [one line summary]
5. Recommendations: [one line summary]

Make sure the summary is clear and professional.`; */

                const prompt = `Please create a concise one paragraph executive summary based on the following FIMI incident information:

${sections.map(section => `${section.name}: ${section.content}`).join('\n\n')}

Make sure the summary is clear and professional.`;

                // Call the AI service
                showProgressIndicator('Calling AI service...');
                const response = await fetch('https://fimi-incident-form-genai.azurewebsites.net/generate-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`AI service error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response format from AI service');
                }
                
                const summary = data.choices[0].message.content.trim();
                
                // Update the executive summary field
                const executiveSummaryField = document.getElementById('executive-summary');
                if (executiveSummaryField) {
                    executiveSummaryField.value = summary;
                    
                    // Add visual indication that the field was auto-generated
                    executiveSummaryField.style.backgroundColor = '#f0fff0'; // Light green background
                    setTimeout(() => {
                        executiveSummaryField.style.backgroundColor = '';
                    }, 3000);
                }
                
                showProgressIndicator('Executive summary generated successfully!', 'success');
                setTimeout(hideProgressIndicator, 3000);
                
            } catch (error) {
                console.error('Error generating executive summary:', error);
                showProgressIndicator(`Error: ${error.message}`, 'error');
                setTimeout(hideProgressIndicator, 5000);
                alert(`Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Generate';
            }
        }
    </script>

    <!-- Author Modal -->
    <div id="authorModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000;">
        <div style="background:white; padding:20px; border-radius:8px; width:300px; margin:100px auto;">
            <h3>Add Author</h3>
            <label>Name: <input type="text" id="modalAuthorName"></label><br><br>
            <label>Organization: <input type="text" id="modalAuthorOrg"></label><br><br>
            <button onclick="submitAuthorModal()">OK</button>
            <button onclick="closeAuthorModal()">Cancel</button>
        </div>
    </div>

    <!-- Country Selector Modal -->
    <div id="countrySelectorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;">Select Targeted Countries</h3>
                <button class="modal-close" onclick="closeCountrySelector()">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="countrySelectorFrame" src="country-selector.html"></iframe>
            </div>
        </div>
    </div>

    <script>
        // Array to store selected countries for Word document generation
        let selectedTargetedCountries = [];

        // Open country selector modal
        function openCountrySelector() {
            const modal = document.getElementById('countrySelectorModal');
            const iframe = document.getElementById('countrySelectorFrame');
            
            // Reload the iframe to sync with current selection
            iframe.src = iframe.src;
            
            // Wait for iframe to load, then send current selection
            iframe.onload = function() {
                setTimeout(function() {
                    iframe.contentWindow.postMessage({
                        type: 'syncSelectedCountries',
                        countries: selectedTargetedCountries
                    }, '*');
                }, 100);
            };
            
            modal.style.display = 'block';
        }

        // Close country selector modal
        function closeCountrySelector() {
            document.getElementById('countrySelectorModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('countrySelectorModal');
            if (event.target === modal) {
                closeCountrySelector();
            }
        }

        // Listen for messages from the country selector iframe
        window.addEventListener('message', function(event) {
            // Security check - only accept messages from same origin
            if (event.origin !== window.location.origin) {
                return;
            }

            if (event.data.type === 'countriesSelected') {
                // Update the selected countries array
                selectedTargetedCountries = event.data.countries;
                
                // Update the display
                updateSelectedCountriesDisplay();
                
                // Close the modal
                closeCountrySelector();
            }
        });

        // Update the display of selected countries
        function updateSelectedCountriesDisplay() {
            const displayContainer = document.getElementById('selected-countries-display');
            
            if (selectedTargetedCountries.length === 0) {
                displayContainer.style.display = 'none';
                return;
            }
            
            displayContainer.style.display = 'block';
            displayContainer.innerHTML = '';
            
            selectedTargetedCountries.forEach((country, index) => {
                const countryItem = document.createElement('div');
                countryItem.className = 'country-item';
                countryItem.innerHTML = `
                    <div class="country-item-info">
                        <span class="country-code-badge">${country.id}</span>
                        <span>${country.name}</span>
                    </div>
                    <button type="button" class="remove-field-btn" onclick="removeTargetedCountry(${index})">
                        Remove
                    </button>
                `;
                displayContainer.appendChild(countryItem);
            });
        }

        // Remove a country from the selected list
        function removeTargetedCountry(index) {
            selectedTargetedCountries.splice(index, 1);
            updateSelectedCountriesDisplay();
        }

        // Get selected countries for Word document generation
        function getSelectedCountries() {
            return selectedTargetedCountries;
        }
    </script>

</body>
</html>